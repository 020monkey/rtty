<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>xTerminal</title>
    <link rel="stylesheet" type="text/css" href="/css/app.css"/>
	<link rel="stylesheet" href="/css/xterm.css" />
	<script src="/js/jquery-1.12.4.min.js"></script>
	<script src="/js/xterm.js"></script>
	<script src="/js/fit.js"></script>
</head>
<body>
    <div id="box">
		<h1>xTerminal</h1>
		<input id="macaddr" type="text" required="required" placeholder="Please input macaddr" name="macaddr"></input>
		<span id="msg" style="display:none; color:red;"></span>
		<button id="connect" class="btn" type="button">Connect</button>
    </div>
	<div id="terminal-container"></div>
	<h1 class="copyright"><font color="white">Copyright Â© 2017 </font><a href="https://github.com/zhaojh329/xterminal" target="_black">zhaojh329 Github</a></h1>
	<script>
		var ws;
		function ab2str(buf) {
			return decodeURIComponent(escape(String.fromCharCode.apply(null, new Uint8Array(buf))));
		}

		function str2ab(str) {
			var buf = new ArrayBuffer(str.length);
			var bufView = new Uint8Array(buf);
			for (var i = 0, strLen = str.length; i < strLen; i++) {
				bufView[i] = str.charCodeAt(i);
			}
			return buf;
		}
		
		function new_session(mac) {
			ws = new WebSocket("wss://" + location.host + "?mac=" + mac);
			ws.onopen = function() {
				var term = new Terminal({
					focus: true,
					cursorBlink: true,
					screenKeys: true
				});
				
				term.on("data", function(data) {
					var binary_data = str2ab(data);
					ws.send(binary_data);
				});
				
				term.on("open", function() {
					window.addEventListener("resize", function(event) {
						term.fit();
					});
					
					term.fit();
				});
				
				ws.binaryType = "arraybuffer";
				
				ws.onmessage = function(evt) {
					if (evt.data instanceof ArrayBuffer) {
						term.write(ab2str(evt.data));
					} else {
						var resp = JSON.parse(evt.data);
						
						if (resp.status == "ok") {
							term.open($("#terminal-container")[0], true);
						} else {
							ws.close();
							$("#msg").html(resp.reason).show();
						}
					}
				};
				
				ws.onclose = function () {
					$("#login").show();
					term.destroy();
				};
			};
		}
		
		$("#connect").click(function() {
			$("#msg").html("");
			$("#login, #msg").hide();
			new_session($("#macaddr").val());
		});
	</script>
</body>
</html>